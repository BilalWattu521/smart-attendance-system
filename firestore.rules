rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // Hardcoded Root Admin UID for bootstrap/bypass
    function isRootAdmin() {
      return isSignedIn() && request.auth.uid == 'YOUR ROOT ADMIN's UID';
    }

    // Helper to get the user's role from their profile document
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Strict lowercase check for 'admin'
    function isAdmin() {
      return isRootAdmin() || (isSignedIn() && getRole() == 'admin');
    }

    // Collection: users
    match /users/{userId} {
      // READ:
      // - Admin can read everything (get and list)
      // - User can read ONLY their own document (get)
      allow get: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      
      // LIST:
      // - Only Admin can list users
      allow list: if isAdmin();

      // WRITE (Create/Update/Delete):
      // - Admin can write anything
      // - User can UPDATE their own doc ONLY to set 'faceEmbedding' and 'faceEnrolledAt'
      //   and ONLY if 'faceEmbedding' does not already exist (Prevent re-enrollment)
      allow write: if isAdmin() || (
        isSignedIn() && request.auth.uid == userId && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['faceEmbedding', 'faceEnrolledAt']) &&
        !resource.data.keys().hasAny(['faceEmbedding']) // Ensure it didn't exist before
      );
    }

    // --- PHASE 2: GEOFENCING ---

    // Campus Config
    // - Any authenticated user (Student/Admin) can read config to check geofence
    // - Only Admin can write/update config
    match /campus/config {
      allow get: if isSignedIn();
      allow write: if isAdmin();
    }

    // Geofence Logs
    // - Admin can read all logs
    // - Student can read/write ONLY their own log
    match /geofence_logs/{userId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // --- PHASE 3: ATTENDANCE REQUESTS ---
    
    // Attendance Requests
    // - Student can CREATE a request with their own UID
    // - Student can READ their own requests
    // - Admin can READ all requests and UPDATE status
    match /attendance_requests/{requestId} {
      // Read: Admin reads all, Student reads own
      allow read: if isAdmin() || (isSignedIn() && resource.data.studentUid == request.auth.uid);
      
      // Create: Student can create with their own UID
      allow create: if isSignedIn() && request.resource.data.studentUid == request.auth.uid;
      
      // Update: Only Admin can update (to change status)
      allow update: if isAdmin();
      
      // Delete: Only Admin
      allow delete: if isAdmin();
    }

    // Attendance Records (verified attendance)
    // - Admin can read/write
    // - Student can read their own
    match /attendance/{date}/records/{userId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow write: if isAdmin();
    }
  }
}
